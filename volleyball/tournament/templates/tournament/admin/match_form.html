{% extends 'tournament/base.html' %}

{% block title %}{% if match %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞{% else %}–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞{% endif %}{% endblock %}
{% block header %}{% if match %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞{% else %}–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞{% endif %}{% endblock %}

{% block navigation %}
<div class="nav-groups">
    <div style="padding: 20px;">
        <a href="{% url 'tournament:admin_matches_list' %}" style="color: #667eea; text-decoration: none; font-weight: 500; display: block; margin-bottom: 20px;">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –º–∞—Ç—á–µ–π
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<h2>{% if match %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞{% else %}–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ç—á–∞{% endif %}</h2>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
{% endif %}

<div style="max-width: 800px; margin-top: 30px;">
    <form method="post" class="admin-form">
        {% csrf_token %}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="tournament">–¢—É—Ä–Ω–∏—Ä *</label>
                <select id="tournament" name="tournament" required onchange="updateTeams()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—É—Ä–Ω–∏—Ä</option>
                    {% for tournament in tournaments %}
                    <option value="{{ tournament.id }}" {% if match and match.tournament.id == tournament.id %}selected{% endif %} data-teams="{{ tournament.teams.all|join:',' }}">
                        {{ tournament.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="stage">–≠—Ç–∞–ø *</label>
                <select id="stage" name="stage" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø</option>
                    {% for stage_value, stage_label in stages %}
                    <option value="{{ stage_value }}" {% if match and match.stage == stage_value %}selected{% endif %}>{{ stage_label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 60px 1fr; gap: 15px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="team_a">–ö–æ–º–∞–Ω–¥–∞ –ê *</label>
                <select id="team_a" name="team_a" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    {% for tournament in tournaments %}
                        {% if match and match.tournament.id == tournament.id %}
                            {% for team in tournament.teams.all %}
                            <option value="{{ team.id }}" {% if match and match.team_a.id == team.id %}selected{% endif %}>
                                {{ team.name }} ({{ team.get_gender_display }})
                            </option>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="text-align: center; margin-bottom: 0;">
                <label style="opacity: 0;">vs</label>
                <div style="font-size: 24px; font-weight: 700; color: #667eea;">vs</div>
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <label for="team_b">–ö–æ–º–∞–Ω–¥–∞ –ë *</label>
                <select id="team_b" name="team_b" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    {% for tournament in tournaments %}
                        {% if match and match.tournament.id == tournament.id %}
                            {% for team in tournament.teams.all %}
                            <option value="{{ team.id }}" {% if match and match.team_b.id == team.id %}selected{% endif %}>
                                {{ team.name }} ({{ team.get_gender_display }})
                            </option>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="venue">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è</label>
                <select id="venue" name="venue">
                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                    {% for venue in venues %}
                    <option value="{{ venue.id }}" {% if match and match.venue.id == venue.id %}selected{% endif %}>{{ venue.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" id="round_number_group">
                <label for="round_number">–ù–æ–º–µ—Ä —Ç—É—Ä–∞</label>
                <input type="number" id="round_number" name="round_number" 
                       value="{% if match %}{{ match.round_number }}{% endif %}" 
                       min="1" max="100">
            </div>
            
            <div class="form-group">
                <label for="date_time">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                <input type="datetime-local" id="date_time" name="date_time" 
                       value="{% if match and match.date_time %}{{ match.date_time|date:'Y-m-dTH:i' }}{% endif %}">
            </div>
        </div>
        
        <div class="form-group" style="padding: 15px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #667eea;">
            <label>
                <input type="checkbox" name="is_finished" {% if match and match.is_finished %}checked{% endif %} id="is_finished" onchange="toggleScoreFields()">
                <strong>–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à–µ–Ω</strong>
            </label>
            <p style="margin: 10px 0 0 0; color: #666; font-size: 13px;">–ï—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω–æ, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å—á–µ—Ç –º–∞—Ç—á–∞ –ø–æ –ø–∞—Ä—Ç–∏—è–º</p>
        </div>
        
        <div id="score_fields" style="display: {% if match and match.is_finished %}block{% else %}none{% endif %};">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h4 style="margin-top: 0;">–°—á–µ—Ç –ø–æ –ø–∞—Ä—Ç–∏—è–º (–¥–æ 3 –ø–æ–±–µ–¥)</h4>
                <p style="margin: 0 0 15px 0; color: #666; font-size: 13px;">
                    –ü–∞—Ä—Ç–∏–∏ –¥–æ 25 –æ—á–∫–æ–≤ (5-—è –¥–æ 15) —Å —Ä–∞–∑–Ω–∏—Ü–µ–π –≤ 2 –æ—á–∫–∞
                </p>
                
                <div id="sets_container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    {% for i in "12345" %}
                    <div class="set-group">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 10px;">–ü–∞—Ä—Ç–∏—è {{ i }}</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" class="set-input set-a" name="set-a-{{ i }}" data-set="{{ i }}" placeholder="–ê" min="0" max="30" 
                                   style="width: 50px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <span style="font-weight: 600;">:</span>
                            <input type="number" class="set-input set-b" name="set-b-{{ i }}" data-set="{{ i }}" placeholder="–ë" min="0" max="30"
                                   style="width: 50px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;" class="set-status"></div>
                    </div>
                    {% endfor %}
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px; border: 1px solid #e9ecef;">
                    <div style="display: grid; grid-template-columns: 1fr 60px 1fr; gap: 15px; align-items: center;">
                        <div>
                            <div style="font-size: 12px; color: #999;">–ò—Ç–æ–≥–æ –ø–∞—Ä—Ç–∏–∏</div>
                            <input type="number" id="sets_a" name="sets_a" placeholder="–ü–∞—Ä—Ç–∏–∏ –ê" min="0" max="3"
                                   value="{% if match %}{{ match.sets_a }}{% endif %}"
                                   style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px; font-weight: 600; background: #f8f9fa;" readonly>
                        </div>
                        <div style="text-align: center; font-size: 24px; font-weight: 700; color: #667eea;">:</div>
                        <div>
                            <div style="font-size: 12px; color: #999;">–ò—Ç–æ–≥–æ –ø–∞—Ä—Ç–∏–∏</div>
                            <input type="number" id="sets_b" name="sets_b" placeholder="–ü–∞—Ä—Ç–∏–∏ –ë" min="0" max="3"
                                   value="{% if match %}{{ match.sets_b }}{% endif %}"
                                   style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px; font-weight: 600; background: #f8f9fa;" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="submit" class="btn-primary">
                {% if match %}üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}‚ûï –°–æ–∑–¥–∞—Ç—å –º–∞—Ç—á{% endif %}
            </button>
            <a href="{% url 'tournament:admin_matches_list' %}" class="btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<style>
    .admin-form {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 12px;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 15px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.2s;
        font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:active {
        transform: translateY(0);
    }
    
    .btn-secondary {
        background: #e9ecef;
        color: #333;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
    }
    
    .btn-secondary:hover {
        background: #dee2e6;
    }
    
    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    @media (max-width: 768px) {
        .admin-form {
            padding: 20px;
        }
        
        .btn-primary, .btn-secondary {
            padding: 10px 20px;
            font-size: 14px;
        }
    }
</style>

<!-- –°–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ set_scores –≤ JavaScript -->
<div id="match-data" data-set-scores="{{ match.set_scores|safe|default:'[]' }}" style="display: none;"></div>

<script>
    function updateTeams() {
        // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç—É—Ä–Ω–∏—Ä–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
        const tournament = document.getElementById('tournament');
        const selectedOption = tournament.options[tournament.selectedIndex];
        // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ
    }
    
    function toggleScoreFields() {
        const isFinished = document.getElementById('is_finished').checked;
        document.getElementById('score_fields').style.display = isFinished ? 'block' : 'none';
        if (!isFinished) {
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –ø–∞—Ä—Ç–∏–π –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
            document.querySelectorAll('.set-input').forEach(input => input.value = '');
            document.getElementById('sets_a').value = '';
            document.getElementById('sets_b').value = '';
        }
    }
    
    function toggleRoundNumber() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç—É—Ä–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ç—É—Ä–æ–≤
        const stage = document.getElementById('stage').value;
        const roundGroup = document.getElementById('round_number_group');
        roundGroup.style.display = stage === 'REGULAR' ? 'block' : 'none';
    }
    
    function validateSetScore(setNum, teamA, teamB) {
        // –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—á–µ—Ç –ø–∞—Ä—Ç–∏–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –≤–æ–ª–µ–π–±–æ–ª—å–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º
        const isLastSet = setNum === 5;
        const maxPoints = isLastSet ? 15 : 25;
        const minDiff = 2;
        
        // –ï—Å–ª–∏ –æ–¥–Ω–∞ –∏–∑ –∫–æ–º–∞–Ω–¥ –º–µ–Ω—å—à–µ maxPoints - –Ω–µ –≤–∞–ª–∏–¥–Ω–æ
        if (teamA < maxPoints && teamB < maxPoints) {
            return false; // –ï—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        }
        
        // –ï—Å–ª–∏ –æ–±–µ –∫–æ–º–∞–Ω–¥—ã >= maxPoints, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É
        if (teamA >= maxPoints && teamB >= maxPoints) {
            if (Math.abs(teamA - teamB) < minDiff) {
                return false; // –†–∞–∑–Ω–∏—Ü–∞ –º–µ–Ω–µ–µ 2
            }
        }
        
        return true; // –í–∞–ª–∏–¥–Ω–æ
    }
    
    function calculateSetWinner(setNum, teamA, teamB) {
        if (!validateSetScore(setNum, teamA, teamB)) {
            return null; // –ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        }
        return teamA > teamB ? 'a' : 'b';
    }
    
    function updateScores() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –ø–æ–ª—è –ø–∞—Ä—Ç–∏–∏
        const setInputs = document.querySelectorAll('.set-input');
        let setsWonA = 0;
        let setsWonB = 0;
        let allValid = true;
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∞—Ä—Ç–∏—è–º
        for (let i = 1; i <= 5; i++) {
            const inputA = document.querySelector(`.set-a[data-set="${i}"]`);
            const inputB = document.querySelector(`.set-b[data-set="${i}"]`);
            const statusDiv = document.querySelector(`.set-group:nth-child(${i}) .set-status`);
            
            const scoreA = parseInt(inputA.value) || 0;
            const scoreB = parseInt(inputB.value) || 0;
            
            if (scoreA === 0 && scoreB === 0) {
                statusDiv.textContent = '';
                allValid = false;
                continue;
            }
            
            const isValid = validateSetScore(i, scoreA, scoreB);
            const winner = calculateSetWinner(i, scoreA, scoreB);
            
            if (winner === 'a') {
                setsWonA++;
                statusDiv.textContent = '‚úì –ö–æ–º–∞–Ω–¥–∞ –ê';
                statusDiv.style.color = '#155724';
            } else if (winner === 'b') {
                setsWonB++;
                statusDiv.textContent = '‚úì –ö–æ–º–∞–Ω–¥–∞ –ë';
                statusDiv.style.color = '#155724';
            } else if (!isValid && (scoreA > 0 || scoreB > 0)) {
                statusDiv.textContent = '–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Å—á–µ—Ç';
                statusDiv.style.color = '#721c24';
                allValid = false;
            }
            
            // –ï—Å–ª–∏ –æ–¥–Ω–∞ –∏–∑ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—É—á–∏–ª–∞ 3 –ø–æ–±–µ–¥, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Å–∫—Ä—ã–≤–∞–µ–º
            if (setsWonA >= 3 || setsWonB >= 3) {
                for (let j = i + 1; j <= 5; j++) {
                    const nextA = document.querySelector(`.set-a[data-set="${j}"]`);
                    const nextB = document.querySelector(`.set-b[data-set="${j}"]`);
                    nextA.disabled = true;
                    nextB.disabled = true;
                    nextA.style.opacity = '0.5';
                    nextB.style.opacity = '0.5';
                }
                break;
            }
        }
        
        // –í–∫–ª—é—á–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ–ª—è –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
        if (setsWonA < 3 && setsWonB < 3) {
            for (let j = 1; j <= 5; j++) {
                const nextA = document.querySelector(`.set-a[data-set="${j}"]`);
                const nextB = document.querySelector(`.set-b[data-set="${j}"]`);
                nextA.disabled = false;
                nextA.style.opacity = '1';
                nextB.disabled = false;
                nextB.style.opacity = '1';
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç –≤ –ø–∞—Ä—Ç–∏—è—Ö
        document.getElementById('sets_a').value = setsWonA;
        document.getElementById('sets_b').value = setsWonB;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º set_scores –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ç—á
        const matchDataElement = document.getElementById('match-data');
        if (matchDataElement) {
            try {
                const setScoresJSON = matchDataElement.getAttribute('data-set-scores');
                const setScores = JSON.parse(setScoresJSON);
                
                if (setScores && Array.isArray(setScores) && setScores.length > 0) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –ø–∞—Ä—Ç–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    setScores.forEach((set, index) => {
                        const setNum = index + 1;
                        const inputA = document.querySelector(`.set-a[data-set="${setNum}"]`);
                        const inputB = document.querySelector(`.set-b[data-set="${setNum}"]`);
                        
                        if (inputA && set.a !== undefined) inputA.value = set.a;
                        if (inputB && set.b !== undefined) inputB.value = set.b;
                    });
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ set_scores:', e);
            }
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç—É—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞
        const stageSelect = document.getElementById('stage');
        if (stageSelect) {
            stageSelect.addEventListener('change', toggleRoundNumber);
            toggleRoundNumber(); // –ò–Ω–∏—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ –≤—Å–µ –ø–æ–ª—è –ø–∞—Ä—Ç–∏–π
        document.querySelectorAll('.set-input').forEach(input => {
            input.addEventListener('change', updateScores);
            input.addEventListener('keyup', updateScores);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç, –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ç—á
        if (document.getElementById('is_finished').checked) {
            updateScores();
        }
    });
</script>
{% endblock %}
