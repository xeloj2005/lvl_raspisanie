{% extends 'tournament/base.html' %}

{% block title %}{{ tournament.name }} - –í–æ–ª–µ–π–±–æ–ª—å–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã{% endblock %}

{% block header %}{{ tournament.name }}{% endblock %}

{% block navigation %}
<div class="nav-groups">
    {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ #}
    {% load static %}
    <div class="nav-groups">
        {% for group in all_groups %}
        <div class="nav-group">
            <div class="group-header {% if group.id == tournament.group.id %}active{% endif %}" onclick="event.stopPropagation(); toggleGroup(this)">
                <span>{{ group.name }}</span>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="tournaments-list {% if group.id == tournament.group.id %}active{% endif %}">
                {% for t in group.tournaments.all %}
                <a href="{% url 'tournament:tournament_detail' t.id %}"
                   class="tournament-link {% if t.id == tournament.id %}current{% endif %}">
                    {{ t.name }} ({{ t.get_gender_display }})
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        <div style="padding: 15px; border-top: 1px solid #e9ecef;">
            <a href="{% url 'tournament:index' %}" style="color: #3b72ff; text-decoration: none; font-weight: 500;">
                ‚Üê –í—Å–µ —Ç—É—Ä–Ω–∏—Ä—ã
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div style="margin-bottom: 30px;">
    <h2>{{ tournament.name }}</h2>
    <div style="color: #666; margin-top: 10px;">
        <span style="background: #e9ecef; padding: 5px 12px; border-radius: 15px; font-size: 14px; margin-right: 10px;">
            {{ tournament.get_gender_display }}
        </span>
        <span style="background: #e9ecef; padding: 5px 12px; border-radius: 15px; font-size: 14px;">
            {{ tournament.get_tournament_type_display }}
        </span>
    </div>
</div>

<!-- Tabs -->
<div class="tabs" style="margin-bottom: 20px; border-bottom: 2px solid #e9ecef;">
    <button class="tab-btn active" data-tab="standings">–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</button>
    {% if tournament.number_of_rounds > 1 %}
    <button class="tab-btn" data-tab="matrix1">–ú–∞—Ç—Ä–∏—Ü–∞ (1 –∫—Ä—É–≥)</button>
    <button class="tab-btn" data-tab="matrix2">–ú–∞—Ç—Ä–∏—Ü–∞ (2 –∫—Ä—É–≥)</button>
    {% else %}
    <button class="tab-btn" data-tab="matrix1">–ú–∞—Ç—Ä–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</button>
    {% endif %}
    {% if tournament.has_playoff %}
    <button class="tab-btn" data-tab="playoff">–ü–ª–µ–π–æ—Ñ—Ñ</button>
    {% endif %}
</div>

<!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
<div class="tab-content active" id="standings">
    <h3>–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h3>
    <div class="table-wrapper">
        <table class="standings-table">
            <thead>
                <tr>
                    <th class="text-center">#</th>
                    <th class="team-name-col">–ö–æ–º–∞–Ω–¥–∞</th>
                    <th class="text-center" title="–ò–≥—Ä—ã">–ò</th>
                    <th class="text-center" title="–ü–æ–±–µ–¥—ã">–í</th>
                    <th class="text-center" title="–ü–æ—Ä–∞–∂–µ–Ω–∏—è">–ü</th>
                    <th class="text-center" title="–í—ã–∏–≥—Ä./–ü—Ä–æ–∏–≥—Ä. –ø–∞—Ä—Ç–∏–∏">–°+/–°-</th>
                    <th class="text-center" title="–í—ã–∏–≥—Ä./–ü—Ä–æ–∏–≥—Ä. –æ—á–∫–∏">–û+/–û-</th>
                    <th class="text-center points-col" title="–¢—É—Ä–Ω–∏—Ä–Ω—ã–µ –æ—á–∫–∏ (3 –∑–∞ 3:0 –∏ 3:1, 2 –∑–∞ 3:2, 1 –∑–∞ 2:3, 0 –∑–∞ 1:3 –∏ 0:3)"><strong>–û</strong></th>
                </tr>
            </thead>
            <tbody>
                {% for standing in standings %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td class="team-name-cell">{{ standing.team.name }}</td>
                    <td class="text-center">{{ standing.played }}</td>
                    <td class="text-center">{{ standing.won }}</td>
                    <td class="text-center">{{ standing.lost }}</td>
                    <td class="text-center">{{ standing.sets_won }}/{{ standing.sets_lost }}</td>
                    <td class="text-center">{{ standing.points_won }}/{{ standing.points_lost }}</td>
                    <td class="text-center points-col"><strong>{{ standing.tournament_points }}</strong></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center" style="padding: 20px; color: #999;">
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div style="margin-top: 15px; font-size: 13px; color: #666;">
        <strong>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è:</strong> –ò - –∏–≥—Ä—ã | –í - –ø–æ–±–µ–¥—ã | –ü - –ø–æ—Ä–∞–∂–µ–Ω–∏—è | –°+/–°- - –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã–µ/–ø—Ä–æ–∏–≥—Ä–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏ | –û+/–û- - –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã–µ/–ø—Ä–æ–∏–≥—Ä–∞–Ω–Ω—ã–µ –æ—á–∫–∏ | –¢.–û. - —Ç—É—Ä–Ω–∏—Ä–Ω—ã–µ –æ—á–∫–∏
    </div>
</div>

<!-- –ú–∞—Ç—Ä–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (1 –∫—Ä—É–≥) -->
<div class="tab-content" id="matrix1">
    <h3>–ú–∞—Ç—Ä–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞{% if tournament.number_of_rounds > 1 %} (1 –∫—Ä—É–≥){% endif %}</h3>
    <div class="table-wrapper">
        <table class="matrix-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ö–æ–º–∞–Ω–¥–∞</th>
                    {% for team in matrix.teams %}
                    <th>{{ forloop.counter }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in matrix.matrix %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td class="team-name">{{ row.team.name }}</td>
                    {% for cell in row.results %}
                        {% if cell.is_self %}
                            <td class="self-cell">‚Äî</td>
                        {% else %}
                            <td>
                                {% if cell.scores.0 != '-' %}
                                    {{ cell.scores.0 }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–∞—Ç—Ä–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (2 –∫—Ä—É–≥) -->
{% if tournament.number_of_rounds > 1 %}
<div class="tab-content" id="matrix2">
    <h3>–ú–∞—Ç—Ä–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (2 –∫—Ä—É–≥)</h3>
    <div class="table-wrapper">
        <table class="matrix-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>–ö–æ–º–∞–Ω–¥–∞</th>
                    {% for team in matrix.teams %}
                    <th>{{ forloop.counter }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in matrix.matrix %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td class="team-name">{{ row.team.name }}</td>
                    {% for cell in row.results %}
                        {% if cell.is_self %}
                            <td class="self-cell">‚Äî</td>
                        {% else %}
                            <td>
                                {% if cell.scores|length > 1 %}
                                    {{ cell.scores.1 }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- –ü–ª–µ–π–æ—Ñ—Ñ -->
{% if tournament.has_playoff %}
<div class="tab-content" id="playoff">
    <h3>–ü–ª–µ–π–æ—Ñ—Ñ</h3>
    {% load static %}
    
    {% if playoff_matches %}
        {% for stage_name, stage_matches in playoff_matches %}
        <div class="round-section">
            <div class="round-title">{{ stage_name }}</div>
            {% for match in stage_matches %}
            <div class="match-card">
                <div class="match-datetime">
                    {% if match.date_time %}
                        {{ match.date_time|date:"d.m.Y" }}<br>
                        {{ match.date_time|date:"H:i" }}
                    {% else %}
                        –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ
                    {% endif %}
                </div>
                <div class="match-team">{{ match.team_a.name }}</div>
                <div class="match-score">
                    {% if match.is_finished %}
                        {{ match.sets_a }}:{{ match.sets_b }}
                    {% else %}
                        vs
                    {% endif %}
                </div>
                <div class="match-team">{{ match.team_b.name }}</div>
                {% if match.venue %}
                <div class="match-venue">{{ match.venue.name }}</div>
                {% endif %}
            </div>
            {% empty %}
            <div style="text-align: center; color: #999; padding: 20px;">
                –ù–µ—Ç –º–∞—Ç—á–µ–π –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    {% else %}
        <div style="padding: 40px; text-align: center; color: #999;">
            –ú–∞—Ç—á–∏ –ø–ª–µ–π–æ—Ñ—Ñ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.<br>
            –ü–ª–µ–π–æ—Ñ—Ñ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–≥–¥–∞ –≤—Å–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –º–∞—Ç—á–∏ –±—É–¥—É—Ç —Å—ã–≥—Ä–∞–Ω—ã.
        </div>
    {% endif %}
</div>
{% endif %}

<!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ - –≤–Ω–µ —Ç–∞–±–æ–≤, –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–∞–º–∏ -->
<div style="margin-top: 50px;">
    <h2>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä</h2>
    {% for round_name, matches in schedule %}
    <div class="round-section">
        <div class="round-title">{{ round_name }}</div>
        {% for match in matches %}
        <div class="match-card">
            <div class="match-datetime">
                {% if match.date_time %}
                    {{ match.date_time|date:"d.m.Y" }}<br>
                    {{ match.date_time|date:"H:i" }}
                {% else %}
                    –î–∞—Ç–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞
                {% endif %}
            </div>
            <div class="match-team">{{ match.team_a.name }}</div>
            <div class="match-score">
                {% if match.is_finished %}
                    {{ match.get_score_display }}
                {% else %}
                    vs
                {% endif %}
            </div>
            <div class="match-team">{{ match.team_b.name }}</div>
            <div class="match-venue">
                {% if match.venue %}
                    üìç {{ match.venue.name }}
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div style="padding: 20px; text-align: center; color: #999;">
            –ú–∞—Ç—á–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
        </div>
        {% endfor %}
    </div>
    {% empty %}
    <div style="padding: 40px; text-align: center; color: #999;">
        –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
    </div>
    {% endfor %}
</div>

<style>
    .tabs {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .tab-btn {
        background: #f8f9fa;
        border: none;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        background: #e9ecef;
    }

    .tab-btn.active {
        background: white;
        color: #3b72ff;
        border-bottom: 3px solid #3b72ff;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .tournament-link.current {
        background: #f8f9fa;
        border-left-color: #3b72ff;
        color: #3b72ff;
        font-weight: 600;
    }

    /* –¢–∞–±–ª–∏—Ü—ã */
    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    table thead {
        background: #003DA5;
        color: white;
        font-weight: 600;
    }

    table th {
        padding: 15px 8px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
    }

    table td {
        padding: 12px 8px;
        border-bottom: 1px solid #e9ecef;
        font-size: 14px;
    }

    table tbody tr:hover {
        background: #f8f9fa;
    }

    table tbody tr:last-child td {
        border-bottom: none;
    }

    .text-center {
        text-align: center !important;
    }

    .team-name-col {
        min-width: 150px;
    }

    .team-name-cell {
        font-weight: 600;
        color: #333;
    }

    .points-col {
        background-color: #f0f4ff;
        font-weight: 700;
        color: #3b72ff;
    }

    /* –ú–∞—Ç—á–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ */
    .round-section {
        margin-bottom: 30px;
    }

    .round-title {
        font-size: 18px;
        font-weight: 700;
        color: #3b72ff;
        padding: 15px 20px;
        background: linear-gradient(135deg, rgba(220, 36, 31, 0.08) 0%, rgba(0, 61, 165, 0.08) 100%);
        border-left: 4px solid #54a4ff;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
    }

    .match-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .match-datetime {
        font-size: 12px;
        color: #666;
        text-align: center;
        min-width: 70px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        font-weight: 500;
    }

    .match-team {
        flex: 1;
        min-width: 150px;
        font-weight: 600;
        color: #333;
        text-align: center;
    }

    .match-score {
        font-size: 18px;
        font-weight: 700;
        color: #000;
        min-width: 60px;
        text-align: center;
    }

    .match-venue {
        font-size: 12px;
        color: #666;
        width: 100%;
        text-align: center;
        padding-top: 10px;
    }

    @media (max-width: 768px) {
        .tabs {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            padding: 10px 15px;
            font-size: 13px;
            white-space: nowrap;
        }

        /* –õ–∏–Ω–µ–π–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        table {
            font-size: 14px;
        }

        table th {
            padding: 12px 8px;
            font-size: 13px;
        }

        table td {
            padding: 11px 8px;
            font-size: 14px;
        }

        .team-name-col {
            min-width: 130px;
        }

        .match-card {
            flex-direction: column;
            padding: 12px;
            gap: 10px;
        }

        .match-datetime {
            width: 100%;
            min-width: unset;
        }

        .match-team {
            width: 100%;
            min-width: unset;
            font-size: 16px;
        }

        .match-score {
            width: 100%;
            font-size: 20px;
        }

        .match-venue {
            width: 100%;
            font-size: 13px;
        }
    }

    @media (max-width: 480px) {
        table th {
            padding: 10px 5px;
            font-size: 12px;
        }

        table td {
            padding: 10px 5px;
            font-size: 13px;
        }

        .team-name-col {
            min-width: 110px;
        }

        .team-name-cell {
            font-size: 12px;
        }
    }
</style>

<script>
    // Group toggle function
    function toggleGroup(header) {
        const list = header.nextElementSibling;
        const isActive = list.classList.contains('active');
        
        // Close all other lists
        document.querySelectorAll('.tournaments-list').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.group-header').forEach(h => h.classList.remove('active'));
        
        // Toggle current
        if (!isActive) {
            list.classList.add('active');
            header.classList.add('active');
        }
    }
    
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });
</script>
{% endblock %}